version: '3.6'
services:
  edgeHub:
    container_name: edgeHubDev
    environment:
    - EdgeModuleHubServerCAChainCertificateFile=/mnt/edgehub/edge-chain-ca.cert.pem
    - EdgeModuleHubServerCertificateFile=/mnt/edgehub/edge-hub-server.cert.pfx
    - configSource=local
    - SSL_CERTIFICATE_PATH=/mnt/edgehub/
    - SSL_CERTIFICATE_NAME=edge-hub-server.cert.pfx
    - routes__sensorToSampleModule=FROM /messages/modules/tempSensor/outputs/temperatureOutput
      INTO BrokeredEndpoint("/modules/SampleModule/inputs/input1")
    - routes__SampleModuleToIoTHub=FROM /messages/modules/SampleModule/outputs/output1
      INTO $$upstream
    - IotHubConnectionString=HostName=HostName;DeviceId=DeviceId;ModuleId=$$edgeHub;SharedAccessKey=SharedAccessKey
    image: mcr.microsoft.com/azureiotedge-hub:1.0
    labels:
      iotedgehubdev: ''
    networks:
      azure-iot-edge:
        aliases:
        - gatewayhost
    ports:
    - 8883:8883/tcp
    - 443:443/tcp
    volumes:
    - source: edgehubdev
      target: /mnt/edgehub
      type: volume
  tempSensor:
    container_name: tempSensor
    depends_on:
    - edgeHub
    environment:
    - EdgeModuleCACertificateFile=/mnt/edgemodule/edge-device-ca.cert.pem
    - EdgeHubConnectionString=HostName=HostName;DeviceId=DeviceId;ModuleId=tempSensor;SharedAccessKey=SharedAccessKey
    image: mcr.microsoft.com/azureiotedge-simulated-temperature-sensor:1.0
    labels:
      iotedgehubdev: ''
    networks:
      azure-iot-edge: null
    restart: always
    volumes:
    - source: edgemoduledev
      target: /mnt/edgemodule
      type: volume
  SampleModule:
    container_name: SampleModule
    depends_on:
    - edgeHub
    environment:
    - EdgeModuleCACertificateFile=/mnt/edgemodule/edge-device-ca.cert.pem
    - EdgeHubConnectionString=HostName=HostName;DeviceId=DeviceId;ModuleId=SampleModule;SharedAccessKey=SharedAccessKey
    image: localhost:5000/samplemodule:0.0.1-amd64
    labels:
      iotedgehubdev: ''
    networks:
      azure-iot-edge: null
    restart: always
    volumes:
    - source: edgemoduledev
      target: /mnt/edgemodule
      type: volume
networks:
  azure-iot-edge:
    external: true
    name: azure-iot-edge-dev
volumes:
  edgehubdev:
    external: true
  edgemoduledev:
    external: true
